(()=>{"use strict";var e,l,t,i,o=function(e,l){return(+e%(l=+l)+l)%l};e=class{constructor(e){this.cellSize=e.cellSize,this.cells={},this.blocksDef=e.blocksDef}vec3(e,l,t){return`${e=parseInt(e)}:${l=parseInt(l)}:${t=parseInt(t)}`}computeVoxelOffset(e,l,t){var i,s,n;return i=0|o(e,this.cellSize),s=0|o(l,this.cellSize),n=0|o(t,this.cellSize),s*this.cellSize*this.cellSize+n*this.cellSize+i}computeCellForVoxel(e,l,t){return[Math.floor(e/this.cellSize),Math.floor(l/this.cellSize),Math.floor(t/this.cellSize)]}addCellForVoxel(e,l,t){var i,o;return o=this.vec3(...this.computeCellForVoxel(e,l,t)),(i=this.cells[o])||(i=new Uint32Array(this.cellSize*this.cellSize*this.cellSize),this.cells[o]=i),i}getCellForVoxel(e,l,t){var i;return i=this.vec3(...this.computeCellForVoxel(e,l,t)),this.cells[i]}setVoxel(e,l,t,i){var o;(o=this.getCellForVoxel(e,l,t))||(o=this.addCellForVoxel(e,l,t)),o[this.computeVoxelOffset(e,l,t)]=i}getVoxel(e,l,t){var i;return(i=this.getCellForVoxel(e,l,t))?i[this.computeVoxelOffset(e,l,t)]:0}getCell(e,l,t){return this.cells[this.vec3(x,y,z)]}setCell(e,l,t,i){return this.cells[this.vec3(e,l,t)]=i}getBlock(e,l,t){var i,o,s;return s=this.getVoxel(e,l,t),void 0!==(o=this.blocksDef[s])&&(i=1===o[1]?"block":"empty",{name:o[0],stateId:s,boundingBox:i,transparent:o[2]})}},i=null,l=class{constructor(l){this.cellSize=l.cellSize,this.cellTerrain=new e({cellSize:this.cellSize,blocksDef:l.blocksDef}),this.toxelSize=l.toxelSize,this.q=1/this.toxelSize,this.blocksMapping=l.blocksMapping,this.blocksTex=l.blocksTex,this.cellNeedsUpdate={},this.loadedMeshes={},this.undefinedBlock="black_shulker_box"}genBlockFace(e,l,t){var i,o,s,n,r,c,a,h,p;switch(void 0!==this.blocksTex[l.name]||void 0!==this.blocksTex[String(l.stateId)]?void 0!==(a=void 0!==this.blocksTex[String(l.stateId)]?this.blocksTex[String(l.stateId)]:this.blocksTex[l.name]).all?(o=this.blocksMapping[a.all].x,s=this.blocksMapping[a.all].y):void 0!==a.side?void 0!==(i={py:"top",ny:"bottom"})[e]?(o=this.blocksMapping[a[i[e]]].x,s=this.blocksMapping[a[i[e]]].y):(o=this.blocksMapping[a.side].x,s=this.blocksMapping[a.side].y):(o=this.blocksMapping[a[e]].x,s=this.blocksMapping[a[e]].y):"water"===l.name?(o=this.blocksMapping.water_flow.x,s=this.blocksMapping.water_flow.y):"lava"===l.name?(o=this.blocksMapping.lava_flow.x,s=this.blocksMapping.lava_flow.y):this.blocksMapping[l.name]?(o=this.blocksMapping[l.name].x,s=this.blocksMapping[l.name].y):(o=this.blocksMapping[this.undefinedBlock].x,s=this.blocksMapping[this.undefinedBlock].y),o-=1,s-=1,r=this.q*o,h=1-this.q*s-this.q,c=this.q*o+this.q,n=[[r,h],[r,p=1-this.q*s],[c,h],[c,p]],e){case"pz":return{pos:[-.5+t[0],-.5+t[1],.5+t[2],.5+t[0],-.5+t[1],.5+t[2],-.5+t[0],.5+t[1],.5+t[2],-.5+t[0],.5+t[1],.5+t[2],.5+t[0],-.5+t[1],.5+t[2],.5+t[0],.5+t[1],.5+t[2]],norm:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],uv:[...n[0],...n[2],...n[1],...n[1],...n[2],...n[3]]};case"nx":return{pos:[.5+t[0],-.5+t[1],.5+t[2],.5+t[0],-.5+t[1],-.5+t[2],.5+t[0],.5+t[1],.5+t[2],.5+t[0],.5+t[1],.5+t[2],.5+t[0],-.5+t[1],-.5+t[2],.5+t[0],.5+t[1],-.5+t[2]],norm:[1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0],uv:[...n[0],...n[2],...n[1],...n[1],...n[2],...n[3]]};case"nz":return{pos:[.5+t[0],-.5+t[1],-.5+t[2],-.5+t[0],-.5+t[1],-.5+t[2],.5+t[0],.5+t[1],-.5+t[2],.5+t[0],.5+t[1],-.5+t[2],-.5+t[0],-.5+t[1],-.5+t[2],-.5+t[0],.5+t[1],-.5+t[2]],norm:[0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[...n[0],...n[2],...n[1],...n[1],...n[2],...n[3]]};case"px":return{pos:[-.5+t[0],-.5+t[1],-.5+t[2],-.5+t[0],-.5+t[1],.5+t[2],-.5+t[0],.5+t[1],-.5+t[2],-.5+t[0],.5+t[1],-.5+t[2],-.5+t[0],-.5+t[1],.5+t[2],-.5+t[0],.5+t[1],.5+t[2]],norm:[-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],uv:[...n[0],...n[2],...n[1],...n[1],...n[2],...n[3]]};case"py":return{pos:[.5+t[0],.5+t[1],-.5+t[2],-.5+t[0],.5+t[1],-.5+t[2],.5+t[0],.5+t[1],.5+t[2],.5+t[0],.5+t[1],.5+t[2],-.5+t[0],.5+t[1],-.5+t[2],-.5+t[0],.5+t[1],.5+t[2]],norm:[0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0],uv:[...n[0],...n[2],...n[1],...n[1],...n[2],...n[3]]};case"ny":return{pos:[.5+t[0],-.5+t[1],.5+t[2],-.5+t[0],-.5+t[1],.5+t[2],.5+t[0],-.5+t[1],-.5+t[2],.5+t[0],-.5+t[1],-.5+t[2],-.5+t[0],-.5+t[1],.5+t[2],-.5+t[0],-.5+t[1],-.5+t[2]],norm:[0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],uv:[...n[0],...n[2],...n[1],...n[1],...n[2],...n[3]]}}}genCellGeo(e,l,t){var i,o,s,n,r,c,a,h,p,k,g,d,u,b,x,T,f,B,v,m,z;for(i=this,u=[],g=[],z=[],n=[],v=[],B=[],m=[],f=[],s=function(e){return 0===e?[.9,.9,.9]:1===e?[.7,.7,.7]:2===e?[.5,.5,.5]:[.3,.3,.3]},o=function(e,l){var t,o,r,c,a,h,p,k,d,b,x,T;for(a=i.genBlockFace(e,i.cellTerrain.getBlock(...l),l),p={},b=h=-1;h<=1;b=++h)for(x=k=-1;k<=1;x=++k)for(T=d=-1;d<=1;T=++d)"block"===i.cellTerrain.getBlock(l[0]+b,l[1]+x,l[2]+T).boundingBox?p[`${b}:${x}:${T}`]=1:p[`${b}:${x}:${T}`]=0;t=s(0),o=s(0),r=s(0),c=s(0),"py"===e&&(t=s(p["1:1:-1"]+p["0:1:-1"]+p["1:1:0"]),o=s(p["1:1:1"]+p["0:1:1"]+p["1:1:0"]),r=s(p["-1:1:-1"]+p["0:1:-1"]+p["-1:1:0"]),c=s(p["-1:1:1"]+p["0:1:1"]+p["-1:1:0"])),"ny"===e&&(o=s(p["1:-1:-1"]+p["0:-1:-1"]+p["1:-1:0"]),t=s(p["1:-1:1"]+p["0:-1:1"]+p["1:-1:0"]),c=s(p["-1:-1:-1"]+p["0:-1:-1"]+p["-1:-1:0"]),r=s(p["-1:-1:1"]+p["0:-1:1"]+p["-1:-1:0"])),"px"===e&&(t=s(p["-1:-1:0"]+p["-1:-1:-1"]+p["-1:0:-1"]),o=s(p["-1:1:0"]+p["-1:1:-1"]+p["-1:0:-1"]),r=s(p["-1:-1:0"]+p["-1:-1:1"]+p["-1:0:1"]),c=s(p["-1:1:0"]+p["-1:1:1"]+p["-1:0:1"])),"nx"===e&&(r=s(p["1:-1:0"]+p["1:-1:-1"]+p["1:0:-1"]),c=s(p["1:1:0"]+p["1:1:-1"]+p["1:0:-1"]),t=s(p["1:-1:0"]+p["1:-1:1"]+p["1:0:1"]),o=s(p["1:1:0"]+p["1:1:1"]+p["1:0:1"])),"pz"===e&&(t=s(p["0:-1:1"]+p["-1:-1:1"]+p["-1:0:1"]),o=s(p["0:1:1"]+p["-1:1:1"]+p["-1:0:1"]),r=s(p["0:-1:1"]+p["1:-1:1"]+p["1:0:1"]),c=s(p["0:1:1"]+p["1:1:1"]+p["1:0:1"])),"nz"===e&&(r=s(p["0:-1:-1"]+p["-1:-1:-1"]+p["-1:0:-1"]),c=s(p["0:1:-1"]+p["-1:1:-1"]+p["-1:0:-1"]),t=s(p["0:-1:-1"]+p["1:-1:-1"]+p["1:0:-1"]),o=s(p["0:1:-1"]+p["1:1:-1"]+p["1:0:-1"])),i.cellTerrain.getBlock(...l).transparent?(v.push(...a.pos),B.push(...a.norm),m.push(...a.uv),f.push(...t,...r,...o,...o,...r,...c)):(u.push(...a.pos),g.push(...a.norm),z.push(...a.uv),n.push(...t,...r,...o,...o,...r,...c))},r=h=0,b=this.cellSize-1;0<=b?h<=b:h>=b;r=0<=b?++h:--h)for(c=p=0,x=this.cellSize-1;0<=x?p<=x:p>=x;c=0<=x?++p:--p)for(a=k=0,T=this.cellSize-1;0<=T?k<=T:k>=T;a=0<=T?++k:--k)d=[e*this.cellSize+r,l*this.cellSize+c,t*this.cellSize+a],"block"===this.cellTerrain.getBlock(...d).boundingBox?this.cellTerrain.getBlock(...d).transparent?("block"!==this.cellTerrain.getBlock(d[0]+1,d[1],d[2]).boundingBox&&o("nx",d),"block"!==this.cellTerrain.getBlock(d[0]-1,d[1],d[2]).boundingBox&&o("px",d),"block"!==this.cellTerrain.getBlock(d[0],d[1]-1,d[2]).boundingBox&&o("ny",d),"block"!==this.cellTerrain.getBlock(d[0],d[1]+1,d[2]).boundingBox&&o("py",d),"block"!==this.cellTerrain.getBlock(d[0],d[1],d[2]+1).boundingBox&&o("pz",d),"block"!==this.cellTerrain.getBlock(d[0],d[1],d[2]-1).boundingBox&&o("nz",d)):(("block"!==this.cellTerrain.getBlock(d[0]+1,d[1],d[2]).boundingBox||this.cellTerrain.getBlock(d[0]+1,d[1],d[2]).transparent)&&o("nx",d),("block"!==this.cellTerrain.getBlock(d[0]-1,d[1],d[2]).boundingBox||this.cellTerrain.getBlock(d[0]-1,d[1],d[2]).transparent)&&o("px",d),("block"!==this.cellTerrain.getBlock(d[0],d[1]-1,d[2]).boundingBox||this.cellTerrain.getBlock(d[0],d[1]-1,d[2]).transparent)&&o("ny",d),("block"!==this.cellTerrain.getBlock(d[0],d[1]+1,d[2]).boundingBox||this.cellTerrain.getBlock(d[0],d[1]+1,d[2]).transparent)&&o("py",d),("block"!==this.cellTerrain.getBlock(d[0],d[1],d[2]+1).boundingBox||this.cellTerrain.getBlock(d[0],d[1],d[2]+1).transparent)&&o("pz",d),("block"!==this.cellTerrain.getBlock(d[0],d[1],d[2]-1).boundingBox||this.cellTerrain.getBlock(d[0],d[1],d[2]-1).transparent)&&o("nz",d)):"water"!==this.cellTerrain.getBlock(...d).name&&"lava"!==this.cellTerrain.getBlock(...d).name||("air"===this.cellTerrain.getBlock(d[0]+1,d[1],d[2]).name&&o("nx",d),"air"===this.cellTerrain.getBlock(d[0]-1,d[1],d[2]).name&&o("px",d),"air"===this.cellTerrain.getBlock(d[0],d[1]-1,d[2]).name&&o("ny",d),"air"===this.cellTerrain.getBlock(d[0],d[1]+1,d[2]).name&&o("py",d),"air"===this.cellTerrain.getBlock(d[0],d[1],d[2]+1).name&&o("pz",d),"air"===this.cellTerrain.getBlock(d[0],d[1],d[2]-1).name&&o("nz",d));return u.push(...v),g.push(...B),z.push(...m),n.push(...f),{positions:u,normals:g,uvs:z,colors:n}}},t={init:function(e){i=new l({models:e.models,blocks:e.blocks,blocksMapping:e.blocksMapping,toxelSize:e.toxelSize,cellSize:e.cellSize,blocksTex:e.blocksTex,blocksDef:e.blocksDef})},setVoxel:function(e){var l,t,o,s,n,r;for(i.cellTerrain.setVoxel(...e),l=i.cellTerrain.vec3(...i.cellTerrain.computeCellForVoxel(e[0],e[1],e[2])),i.cellNeedsUpdate[l]=!0,t=0,o=(r=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]]).length;t<o;t++)s=r[t],n=i.cellTerrain.vec3(...i.cellTerrain.computeCellForVoxel(e[0]+s[0],e[1]+s[1],e[2]+s[2])),i.cellNeedsUpdate[n]=!0},genCellGeo:function(e){var l;i.cellTerrain.vec3(...e)in i.cellTerrain.cells==1&&(performance.now(),l=i.genCellGeo(...e),performance.now(),postMessage({type:"cellGeo",data:{cell:l,info:e,p:performance.now()}}))},setCell:function(e){var l,t,o,s,n;for(n=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],i.cellNeedsUpdate[i.cellTerrain.vec3(e[0],e[1],e[2])]=!0,i.cellTerrain.setCell(e[0],e[1],e[2],e[3]),l=0,t=n.length;l<t;l++)o=n[l],s=i.cellTerrain.vec3(e[0]+o[0],e[1]+o[1],e[2]+o[2]),i.cellNeedsUpdate[s]=!0},resetWorld:function(e){console.log("RESET WORLD!"),i.cellTerrain.cells={}},updateCellsAroundPlayer:function(e){var l,o,s,n,r,c,a,h,p,k,g,d,u,b,x,T,f,B,v,m,z,S,M,y;for(c in l=e[0],u=e[1],g={},o={},b=i.loadedMeshes)!0===b[c]&&(o[c]=!0);for(r=a=0,x=u;0<=x?a<=x:a>=x;r=0<=x?++a:--a)for(S=h=T=-r,f=r;T<=f?h<=f:h>=f;S=T<=f?++h:--h)for(M=p=B=-r,v=r;B<=v?p<=v:p>=v;M=B<=v?++p:--p)for(y=k=m=-r,z=r;m<=z?k<=z:k>=z;y=m<=z?++k:--k)g[`${S}:${M}:${y}`]||(g[`${S}:${M}:${y}`]=!0,d=[l[0]+S,l[1]+M,l[2]+y],o[s=i.cellTerrain.vec3(...d)]=!1,n=!1,i.cellNeedsUpdate[s]&&(delete i.cellNeedsUpdate[s],t.genCellGeo(d),n=!0),"disposed"===i.loadedMeshes[s]&&(n||t.genCellGeo(d)),i.loadedMeshes[s]=!0);for(c in o)!0===o[c]&&(i.loadedMeshes[c]="disposed",postMessage({type:"removeCell",data:c}))}},addEventListener("message",(function(e){var l;if(!(l=t[e.data.type]))throw new Error(`no handler for type: ${e.data.type}`);l(e.data.data)}))})();